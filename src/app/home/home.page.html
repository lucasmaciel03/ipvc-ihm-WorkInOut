<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title> WorkInOut </ion-title>
    <ion-buttons slot="end">
      <ion-button id="language-popover-button">
        <ion-icon name="language-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-popover trigger="language-popover-button" dismissOnSelect="true">
  <ng-template>
    <ion-list>
      <ion-item button (click)="currentLanguage = 'pt'; changeLanguage()">
        <ion-label>Português</ion-label>
        <ion-icon *ngIf="currentLanguage === 'pt'" name="checkmark" slot="end"></ion-icon>
      </ion-item>
      <ion-item button (click)="currentLanguage = 'en'; changeLanguage()">
        <ion-label>English</ion-label>
        <ion-icon *ngIf="currentLanguage === 'en'" name="checkmark" slot="end"></ion-icon>
      </ion-item>
      <ion-item button (click)="currentLanguage = 'es'; changeLanguage()">
        <ion-label>Español</ion-label>
        <ion-icon *ngIf="currentLanguage === 'es'" name="checkmark" slot="end"></ion-icon>
      </ion-item>
    </ion-list>
  </ng-template>
</ion-popover>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="page-container">
    <ion-grid>
      <ion-row>
        <ion-col size="12">
          <ion-item lines="none" class="language-selector">
            <ion-label>Idioma:</ion-label>
            <ion-select
              [(ngModel)]="currentLanguage"
              (ionChange)="changeLanguage()"
            >
              <ion-select-option value="pt-pt"
                >Português (Portugal)</ion-select-option
              >
              <ion-select-option value="pt-br"
                >Português (Brasil)</ion-select-option
              >
              <ion-select-option value="en">English</ion-select-option>
              <ion-select-option value="es">Español</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
      </ion-row>
      <ion-row>
        <ion-col size="12">
          <ion-searchbar
            [(ngModel)]="searchTerm"
            (ionChange)="searchExercises()"
            placeholder="Search exercises"
            animated
            color="light"
            [disabled]="loading"
          ></ion-searchbar>
        </ion-col>
      </ion-row>

      <!-- Loading State -->
      <ion-row *ngIf="loading">
        <ion-col size="12">
          <div class="loading-container">
            <ion-spinner name="crescent"></ion-spinner>
            <p>Loading exercise data...</p>
          </div>
        </ion-col>
      </ion-row>

      <!-- Error State -->
      <ion-row *ngIf="apiError">
        <ion-col size="12">
          <div class="error-container">
            <ion-icon name="warning-outline"></ion-icon>
            <h2>API Error</h2>
            <p>{{ apiError }}</p>
            <ion-button (click)="loadData()">Retry</ion-button>
          </div>
        </ion-col>
      </ion-row>

      <!-- Exercise Grid with Images -->
      <ion-row *ngIf="!loading && !apiError">
        <ion-col size="12">
          <h2 class="section-title">Featured Exercises</h2>
        </ion-col>

        <ion-col
          size="12"
          size-md="6"
          size-lg="4"
          *ngFor="let exercise of exercises"
        >
          <ion-card class="exercise-card">
            <div class="exercise-image-container">
              <img
                *ngIf="exercise.images && exercise.images.length"
                [src]="exercise.images[0].image"
                [alt]="exercise.name"
                (error)="handleImageError($event, exercise)"
                class="exercise-image"
                [class.fallback-image]="exercise.images[0].is_fallback"
              />
              <div
                *ngIf="!exercise.images || !exercise.images.length"
                class="no-image"
              >
                <ion-icon name="fitness-outline"></ion-icon>
              </div>

              <!-- Badge for fallback images -->
              <div
                class="image-badge"
                *ngIf="exercise.images && exercise.images.length && exercise.images[0].is_fallback"
              >
                <ion-icon name="barbell-outline"></ion-icon>
              </div>
            </div>

            <ion-card-header>
              <ion-card-subtitle>
                <div class="muscle-tags">
                  <ion-badge
                    color="primary"
                    *ngFor="let id of exercise.muscles.slice(0, 2)"
                  >
                    {{ getMuscleNameById(id) }}
                  </ion-badge>
                </div>
              </ion-card-subtitle>
              <ion-card-title>{{ exercise.name }}</ion-card-title>
              <ion-card-subtitle
                *ngIf="exercise.language"
                class="language-indicator"
              >
                Idioma: {{ getLanguageName(exercise.language) }}
              </ion-card-subtitle>
            </ion-card-header>

            <ion-card-content>
              <p [innerHTML]="getShortDescription(exercise.description)"></p>
              <ion-button
                expand="block"
                [routerLink]="['/exercise-details', exercise.id]"
              >
                View Details
              </ion-button>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>

      <!-- Muscle Groups Section -->
      <ion-row *ngIf="!loading && !apiError && muscles.length > 0">
        <ion-col size="12">
          <h2 class="section-title">Muscle Groups</h2>
        </ion-col>

        <ion-col
          size="6"
          size-md="4"
          size-lg="3"
          *ngFor="let muscle of muscles"
        >
          <ion-card class="muscle-card">
            <ion-card-header>
              <ion-card-title>{{ muscle.name }}</ion-card-title>
            </ion-card-header>
            <ion-card-content>
              <div class="muscle-image">
                <img
                  [src]="muscle.image_url_main || 'assets/muscle-placeholder.png'"
                  [alt]="muscle.name"
                />
              </div>
              <ion-button expand="block" fill="clear">
                Browse Exercises
              </ion-button>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
</ion-content>
